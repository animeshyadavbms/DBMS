create database employee;
use employee;

CREATE TABLE DEPT (
    DEPTNO INT PRIMARY KEY,
    DNAME VARCHAR(50),
    DLOC VARCHAR(50)
);

CREATE TABLE EMPLOYEE (
    EMPNO INT PRIMARY KEY,
    ENAME VARCHAR(50),
    MGR_NO INT,
    HIREDATE DATE,
    SAL DECIMAL(10,2),
    DEPTNO INT,
    FOREIGN KEY (DEPTNO) REFERENCES DEPT(DEPTNO),
    FOREIGN KEY (MGR_NO) REFERENCES EMPLOYEE(EMPNO)
);

CREATE TABLE PROJECT (
    PNO INT PRIMARY KEY,
    PNAME VARCHAR(50),
    PLOC VARCHAR(50)
);

CREATE TABLE ASSIGNED_TO (
    EMPNO INT,
    PNO INT,
    JOB_ROLE VARCHAR(50),
    PRIMARY KEY (EMPNO, PNO),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO),
    FOREIGN KEY (PNO) REFERENCES PROJECT(PNO)
);

CREATE TABLE INCENTIVES (
    EMPNO INT,
    INCENTIVE_DATE DATE,
    INCENTIVE_AMOUNT DECIMAL(10,2),
    PRIMARY KEY (EMPNO, INCENTIVE_DATE),
    FOREIGN KEY (EMPNO) REFERENCES EMPLOYEE(EMPNO) 
);


INSERT INTO DEPT VALUES
(10, 'HR', 'Bengaluru'),
(20, 'Finance', 'Hyderabad'),
(30, 'IT', 'Mysuru'),
(40, 'Admin', 'Bengaluru'),
(50, 'Sales', 'Hyderabad');

INSERT INTO EMPLOYEE VALUES
(101, 'Amit', NULL, '2018-06-15', 60000, 10),
(102, 'Bharat', 101, '2019-08-10', 50000, 20),
(103, 'Charan', 101, '2020-03-12', 55000, 30),
(104, 'Deepa', 102, '2021-04-20', 45000, 40),
(105, 'Esha', 103, '2022-01-05', 48000, 50),
(106, 'Farah', 101, '2023-07-10', 52000, 30);

INSERT INTO PROJECT VALUES
(1001, 'Payroll System', 'Bengaluru'),
(1002, 'Inventory', 'Hyderabad'),
(1003, 'ERP', 'Mysuru'),
(1004, 'HRMS', 'Bengaluru'),
(1005, 'CRM', 'Hyderabad');

INSERT INTO ASSIGNED_TO VALUES
(101, 1001, 'Manager'),
(102, 1002, 'Analyst'),
(103, 1003, 'Developer'),
(104, 1004, 'Tester'),
(105, 1005, 'Support'),
(106, 1003, 'Developer');

INSERT INTO INCENTIVES VALUES
(101, '2019-01-15', 5000),
(102, '2019-01-20', 3000),
(103, '2020-02-10', 4000),
(105, '2019-01-25', 3500),
(106, '2021-03-12', 2000);


SELECT DISTINCT E.EMPNO
FROM EMPLOYEE E
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
JOIN PROJECT P ON A.PNO = P.PNO
WHERE P.PLOC IN ('Bengaluru', 'Hyderabad', 'Mysuru');


SELECT EMPNO
FROM EMPLOYEE
WHERE EMPNO NOT IN (SELECT EMPNO FROM INCENTIVES);


SELECT E.EMPNO, E.ENAME, E.DEPTNO, D.DNAME, D.DLOC, A.JOB_ROLE, P.PLOC
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
JOIN ASSIGNED_TO A ON E.EMPNO = A.EMPNO
JOIN PROJECT P ON A.PNO = P.PNO
WHERE D.DLOC = P.PLOC;



SELECT E.ENAME AS MANAGER_NAME
FROM EMPLOYEE E
JOIN EMPLOYEE S ON E.EMPNO = S.MGR_NO
GROUP BY E.ENAME
HAVING COUNT(S.EMPNO) = (
    SELECT MAX(CNT)
    FROM (
        SELECT COUNT(S1.EMPNO) AS CNT
        FROM EMPLOYEE E1
        JOIN EMPLOYEE S1 ON E1.EMPNO = S1.MGR_NO
        GROUP BY E1.ENAME
    ) TEMP
);


SELECT DISTINCT E.ENAME AS MANAGER_NAME
FROM EMPLOYEE E
JOIN EMPLOYEE S ON E.EMPNO = S.MGR_NO
GROUP BY E.EMPNO, E.ENAME, E.SAL
HAVING E.SAL > AVG(S.SAL);


SELECT D.DNAME, E.ENAME AS SECOND_TOP_MANAGER
FROM EMPLOYEE E
JOIN DEPT D ON E.DEPTNO = D.DEPTNO
WHERE E.MGR_NO IN (
    SELECT EMPNO FROM EMPLOYEE WHERE MGR_NO IS NULL
);


SELECT *
FROM INCENTIVES
WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
AND INCENTIVE_AMOUNT = (
    SELECT MAX(INCENTIVE_AMOUNT)
    FROM INCENTIVES
    WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
    AND INCENTIVE_AMOUNT < (
        SELECT MAX(INCENTIVE_AMOUNT)
        FROM INCENTIVES
        WHERE INCENTIVE_DATE BETWEEN '2019-01-01' AND '2019-01-31'
    )
);


SELECT E.EMPNO, E.ENAME, E.DEPTNO
FROM EMPLOYEE E
JOIN EMPLOYEE M ON E.MGR_NO = M.EMPNO
WHERE E.DEPTNO = M.DEPTNO;

